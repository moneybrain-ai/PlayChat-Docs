# 차례
*	[어떤 챗봇을 원하세요?](#어떤-챗봇을-원하세요)
	* [대화 시나리오](#대화-시나리오)
*	[`대화 시나리오`를 이용한 챗봇 구축하기](#대화-시나리오를-이용한-챗봇-구축하기)
	* [대화 카드 만들기](#대화-카드-만들기)
	* [크롤링 시나리오 만들기](#크롤링-시나리오-만들기)
	* [재질의 카드 만들기](#재질의-카드-만들기)
*	[`답변 전 실행함수` 적용하기](#답변-전-실행함수-적용하기)
	* [변수 저장하기](#변수-저장하기)
	* [저장된 변수 이용하기](#저장된-변수-이용하기)
	* [크롤링 실행하기](#크롤링-실행하기)

## 어떤 챗봇을 원하세요?
PlayChat 챗봇은 사용자의 질문과 챗봇 답변을 기본 단위로 하여 연속적인 대화를 이어나갑니다. PlayChat 챗봇은 크게 2가지 방식으로 만들 수 있습니다.  
<a href="https://raw.githubusercontent.com/moneybrain-ai/PlayChat-Docs/master/start_image/9.png" target="_blank"><img src="https://github.com/moneybrain-ai/PlayChat-Docs/blob/master/start_image/9.png" title="클릭"/></a>  

### 대화 시나리오
PlayChat이 제공하는 대화 시나리오 그래프를 이용해 챗봇을 구축하는 방법입니다. 대화 시나리오를 이용할 경우 일대일 질문 답변을 넘어, 특정 절차와 기능이 필요한 대화(크롤링, 핸드폰 인증하기, 외부 서버 연동하기 등)를 구현할 수 있습니다.  
[![Video Label](http://img.youtube.com/vi/DhFCZkb-zVM/0.jpg)](https://youtu.be/DhFCZkb-zVM?t=0s)

>참고
>* 대화 셋과 대화 시나리오를 연계하여 챗봇을 구축할 수 있으며, 이 경우 더욱 자연스럽고 실용적인 챗봇을 만들 수 있습니다. 
>* 만들고자하는 챗봇의 목적에 따라 대화 셋을 기반으로 챗봇을 구축할지, 아니면 대화 시나리오를 기반으로 챗봇을 구축할지 결정하는 것이 좋습니다.


## 대화 시나리오를 이용한 챗봇 구축하기
이 문서에서는 **대화 시나리오**를 이용하여 기초적인 **크롤링 챗봇** 을 만들어봅니다. 크롤링 챗봇은 특정 웹 페이지의 데이터를 추출해 내는 챗봇입니다.

대화 시나리오를 이용해 챗봇을 구축하기 위해서는 사용자 입력과 챗봇 답변으로 이루어진 대화 시나리오의 기본 단위(카드)를 만들어야 합니다. 대화 시나리오는 사용자 입력과 챗봇 답변으로 이루어진 대화 카드의 집합으로 이루어지며, 다중의 대화 시나리오를 챗봇에 학습시킬 수도 있습니다.

### 챗봇 만들기
다음 단계에 따라 챗봇을 생성합니다.

1. PlayChat 계정이 없다는 먼저 회원가입을 진행해주세요. 만약 PlayChat 계정이 있다면 로그인 해주세요.
2. "챗봇 관리" 화면에서 새 봇 만들기 -> 빈봇 을 선택합니다. 
3. 빈 칸을 입력합니다.
4. 저장 버튼을 누르세요.

챗봇이 생성되면 챗봇이 카드 형태로 나타납니다. 챗봇 개발을 위해 만들어진 챗봇을 선택합니다.

### 대화 카드 만들기   

대화 시나리오는 사용자 입력과 챗봇 답변으로 이루어진 카드로 구성됩니다. 고급 기능을 이용할 경우, 카드에 답변 전 실행함수를 추가할 수 있습니다. 

다음 단계에 따라 카드를 만듭니다.  
[![Watch the video](https://github.com/moneybrain-ai/PlayChat-Docs/blob/master/video/playyoutube1.png)](https://youtu.be/44QP-8ooqto)       

1. 화면 왼쪽 네비게이션 바의 개발 -> 대화 시나리오를 선택합니다.
2. 시작 카드의 오른쪽 추가하기 버튼을 선택하고 카드 이름을 "크롤링 시작 카드" 라고 입력합니다. 카드 이름은 해당 카드를 지칭하는 이름으로써 카드에 대한 식별자 역할을 합니다.
3. 사용자 입력 칸에는 예상되는 챗봇 사용자의 질문을 입력합니다. 크롤링 챗봇을 만들고 있기 때문에, 사용자 입력에 크롤링에 대한 질문을 입력합니다. 다양한 질문들을 입력할수록 다양한 사용자의 질문을 챗봇이 이해할 수 있습니다.
다음의 예시 질문들을 사용자 입력에 입력하세요. 복수의 사용자 입력을 입력하기 위해서는 사용자 입력 칸의 + 버튼을 누르세요. 
	* 크롤링
	* 크롤링 시작
	* 크롤링 기능
4. 챗봇 답변 칸에는  챗봇이 출력할 답변을 입력합니다. 챗봇 답변으로 크롤링하기 원하는 웹페이지의 주소를 물어봅니다. 복수의 챗봇 답변을 입력하기 위해서는 챗봇 답변 칸의 + 버튼을 누르세요. 
	* 어떤 웹사이트를 크롤링할까요?
	* 크롤링 원하시는 웹사이트 주소를 알려주세요.

	 챗봇 답변을 복수로 입력했을 경우, 랜덤으로 복수의 답변 중 하나가 출력됩니다.
5. 저장 버튼을 누르세요.

> 테스트하기
>1.	챗봇이 질문을 이해하고 사용자에게 답변 할 준비가 되었습니다. 화면 오른쪽 테스트 대화창에서 카드의 사용자 입력 칸에 저장한 질문을 입력해보세요. 준비된 챗봇 답변이 출력되는 걸 확인할 수 있습니다.
>2.	화면 아래에 실시간 대화 분석창이 등장합니다. 사용자 입력과 챗봇 답변으로 구성된 대화의 기본 단위 카드에 대한 분석을 제공합니다. 
>    * 사용자 입력 분석 - 챗봇 사용자의 입력값을 자연어 처리하여 그 결과를 보여줍니다.
>    * 인텐트 분석 - 챗봇 사용자의 입력값과 매칭된 인텐트를 보여줍니다.
>    * 엔터티 분석 - 챗봇 사용자의 입력값에서 축출된 엔터티를 보여줍니다.
>    * 챗봇 답변 분석 - 챗봇 사용자의 입력값이 카드와 매칭되어 챗봇 답변이 출력되었는지에 관한 정보를 보여줍니다.



### 크롤링 시나리오 만들기  

대화 시나리오는 카드들의 집합을 의미합니다. 시작 카드에 크롤링 시작 카드를 추가했던 것처럼, 특정 카드에 자식카드를 추가하거나 형제 카드를 추가할 수 있습니다. 다수의 카드들을 연결하게 되면 카드들은 트리 형태의 그래프가 되고, 이렇게 연결된 카드들을 대화 시나리오라고 칭합니다.  
[![Watch the video](https://github.com/moneybrain-ai/PlayChat-Docs/blob/master/video/playyoutube1.png)](https://youtu.be/lwenTu4GezA)          

> 대화 시나리오는 왜 필요할까요?
크롤링 챗봇이 사용자들로 부터 1) 크롤링하고자 하는 웹사이트와 2) 해당 웹사이트에서 얻고자하는 데이터를 입력받고 3) 크롤링을 실행한다고 생각해 봅시다. 
>
>1. 크롤링 원하는 웹사이트 주소를 입력 받는다.
>2. 해당 웹사이트에 대한 선택자를 입력 받는다.
>3. 크롤링한다.
>    * 크롤링 결과가 문제가 없을 경우, 해당 결과를 출력한다.
>    * 크롤링 결과가 없을 경우, 웹사이트 주소 재입력(1번) 절차로 돌아가거나, 웹사이트의 데이터 부분 재입력(2번) 절차로 돌아간다.
>
>크롤링 기능을 수행하기 위해 위의 절차가 순서대로 진행됩니다. 이 경우, 하나의 카드로 모든 절차를 구현하는 것이 가능하지만 초보자에게는 어렵거나 직관적이지 않을 수 있습니다. 왜냐하면 **하나의 카드는 원칙적으로 하나의 기능을 구현**하는 것이 쉽고, 직관적이기 때문입니다. 크롤링의 경우 웹사이트 주소를 입력받는 기능과 선택자를 입력받는 기능 그리고 크롤링 기능이 포함되기에 3 개의 카드를 연결하여 크롤링 시나리오를 만드는 것이 편리하고 직관적입니다. 즉, 어떤 기능을 수행하기 위해 특정 절차를 만드는 것이 편리하거나 필요할 경우, 자식 카드를 추가하여 시나리오를 만들 수 있습니다. 



다음 단계에 따라 크롤링  시나리오를 만듭니다.  
<a href="https://raw.githubusercontent.com/moneybrain-ai/PlayChat-Docs/master/start_image/17.png" target="_blank"><img src="https://github.com/moneybrain-ai/PlayChat-Docs/blob/master/start_image/17.png" title="클릭"/></a>  
1. 크롤링 시작 카드의 자식카드로 "웹사이트 주소 입력" 카드를 만듭니다.
	* 카드 이름 - 웹사이트 주소 입력
	* 사용자 입력 - $url
	* 챗봇 답변 - 해당 웹사이트의 선택자를 입력하세요

	사용자 입력에 $를 입력할 경우, 입력 가이드가 등장합니다. $url을 선택합니다. $(타입)의 경우 사용자 입력에서 특정 형태를 받겠다는 의미입니다. 타입은 웹사이트 주소와 같은 특정 패턴 값을 입력받고 싶을 때 이용할 수 있습니다.  

2. 웹사이트 주소 입력 카드의 자식카드로 "선택자 입력" 카드를 만듭니다.
	* 카드 이름 - 선택자 입력
	* 사용자 입력 - if(true)
	* 챗봇 답변 - 크롤링하시겠습니까?

	사용자 입력에 if()를 입력할 경우, 입력 모드가 변합니다. if(true)라고 입력합니다. if(조건식)의 경우 사용자의 입력값과 상관없이 해당 카드를 실행하겠다는 의미입니다. 조건식에는 자바스크립트 코드가 들어갑니다. 조건식으로 true 값을 넣을 경우, 조건식은 항상 실행됨을 의미하게 됩니다.

	선택자(Selector)란 웹 페이지에서 특정 요소를 선택하게 해주는 표현식이라고 이해할 수 있습니다. 뒤에서 사용법에 관해 더 자세히 설명합니다. 

3. 데이터 부분 입력 카드의 자식 카드로 "크롤링 실행" 카드를 만듭니다. 
	* 카드 이름 - 크롤링 실행
	* 사용자 입력 - 실행
	* 챗봇 답변 - 크롤링 결과는 다음과 같습니다. 

> 테스트하기
테스트 대화창에서 시나리오에 따라 챗봇과 대화해보세요. 
>1. 크롤링 시작 - 크롤링 시작 이라고 입력했을 경우, 웹사이트 주소를 입력하라고 챗봇이 답변합니다. 
>2. 웹사이트 주소 입력 - 웹사이트 주소를 정확히 입력했을 경우, 해당 웹사이트의 선택자를 입력하라고 챗봇이 답변합니다. 
>3. 선택자 입력 - 선택자를 입력했을 경우, 크롤링 진행 여부를 물어봅니다. 
>4. 크롤링 실행 - 실행이라고 입력했을 경우, 크롤링 결과를 챗봇이 답변합니다.  
<a href="https://raw.githubusercontent.com/moneybrain-ai/PlayChat-Docs/master/start_image/18.png" target="_blank"><img src="https://github.com/moneybrain-ai/PlayChat-Docs/blob/master/start_image/18.png" title="클릭"/></a>  

크롤링 기능을 수행하기 위한 기본적인 대화 시나리오가 완성되었습니다. 지금부터는 사용자가 웹사이트 주소를 제대로 입력하지 않았을 경우, 이를 다시 입력받는 방법을 살펴보겠습니다.

###  재질의 카드 만들기  
웹사이트 주소 입력 카드에서는 $url 타입으로 사용자에게 웹사이트 주소 형식을 입력 받습니다. 하지만 사용자가 웹사이트 주소 형식이 아닌 값을 입력했을 경우, 해당 챗봇은 "알아들을 수 없습니다."라고 답변합니다. 챗봇이 더 자연스럽기 위해서는 정확한 웹사이트 주소를 입력해달라는 재질의 기능이 필요합니다.  
[![Watch the video](https://github.com/moneybrain-ai/PlayChat-Docs/blob/master/video/playyoutube1.png)](https://youtu.be/K_VSr11x8o4)            

다음 단계에 따라 웹사이트 주소 재질의 카드를 만듭니다.
1. 웹사이트 주소 입력 카드의 동생 카드로 "웹사이트 주소 재질의" 카드를 만듭니다. 
	*	카드 이름 - 웹사이트 주소 재질의
	*	사용자 입력 - if(true)
	*	챗봇 답변 - 웹사이트 주소 형식에 맞게 다시 입력해주세요.
2. 챗봇 답변에서 대화흐름 조절 -> 다시 질문하기를 선택합니다.
3. 저장 버튼을 누르세요.  
<a href="https://raw.githubusercontent.com/moneybrain-ai/PlayChat-Docs/master/start_image/19.png" target="_blank"><img src="https://github.com/moneybrain-ai/PlayChat-Docs/blob/master/start_image/19.png" title="클릭"/></a>  

카드의 실행은 상위에 있는 자식 카드부터 검색합니다. 따라서 웹사이트 주소 입력 카드의 사용자 입력을 검색하고 매칭이 되지 않았을 경우, 그 하위 카드(웹사이트 주소 재질의 카드)의 사용자 입력을 검색합니다. 웹사이트 주소 재질의 카드의 사용자 입력은 if(true)이기 때문에 사용자의 입력값과 상관없이 항상 실행됩니다. 따라서 챗봇 사용자가 웹사이트 주소 형식이 아닌 값을 입력했을 경우, 웹사이트 주소 입력 카드의 사용자 입력값인 $url에 매칭되지 않고 그에 따라 그 하위 카드인 웹사이트 주소 재질의 카드와 매칭됩니다. 
웹사이트 주소 재질의 카드가 실행되면, "웹사이트 주소 형식에 맞게 다시 입력해주세요."라는 답변이 출력됩니다. 이 때, 대화흐름 조절을 다시 질문하기로 설정하면 대화 흐름의 커서가 실행된 카드의 부모 카드로 되돌아 갑니다. 그 결과, 사용자가 웹사이트 주소 형식에 맞는 값을 입력했을 경우에만 웹사이트 주소 입력 카드가 실행되고, 그렇지 않을 경우에는 몇번이고 웹사이트 주소를 재질의합니다. 

> 테스트하기
테스트 대화창에서 시나리오에 따라 챗봇과 대화해보세요. 크롤링 입력 후, 웹 사이트 주소가 아닌 값을 입력해봅니다. 그리고 웹 사이트 주소를 입력해 봅니다.  
<a href="https://raw.githubusercontent.com/moneybrain-ai/PlayChat-Docs/master/start_image/20.png" target="_blank"><img src="https://github.com/moneybrain-ai/PlayChat-Docs/blob/master/start_image/20.png" title="클릭"/></a>  


### 마무리
지금까지 **대화 시나리오를 이용한 챗봇 구축하기**를 살펴봤습니다. 대화 시나리오를 이용한 챗봇은 대화 카드를 연결하여 시나리오가 필요한 챗봇을 구축할 수 있었습니다. 하지만, 실제로 챗봇이 웹사이트를 크롤링하기 위해서는 답변 전 실행함수를 추가해야 합니다. 
다음 문서(답변 전 실행함수 적용하기)에서는 실제로 웹사이트를 크롤링하는 기능을 실현해봅니다. 


## 답변 전 실행함수 적용하기
답변 전 실행함수는 외부 서버의 자원(웹 사이트 정보, 날씨 정보, 영화 정보 등)을 이용해야 하는 경우나, 코드 레벨에서의 조작이 필요한 경우에 이용할 수 있는 기능입니다. 예를 들어, 웹 크롤링 챗봇을 작동시키기 위해서는 크롤링 원하는 웹사이트의 주소와 선택자를 저장하는 기능과 크롤링을 실행하는 기능이 필요합니다. 이 문서에서는 해당 기능을 구현해봅니다.  
[![Watch the video](https://github.com/moneybrain-ai/PlayChat-Docs/blob/master/video/playyoutube1.png)](https://youtu.be/os-xEqSxn9w)            

### 변수 저장하기
크롤링을 위해서는 사용자가 입력한 웹사이트 주소와 선택자를 저장해두어야 합니다. 사용자의 입력과 같은 특정한 값을 저장해두기 위해서는 답변 적 실행함수를 이용할 수 있습니다.

다음 단계에 따라 답변 전 실행함수(saveUrl)를 만듭니다.  
<a href="https://raw.githubusercontent.com/moneybrain-ai/PlayChat-Docs/master/start_image/21.png" target="_blank"><img src="https://github.com/moneybrain-ai/PlayChat-Docs/blob/master/start_image/21.png" title="클릭"/></a>  
1. 웹사이트 주소 입력 카드를 더블 클릭하여 카드 수정창을 엽니다.
2. 답변 전 실행함수에 saveUrl을 입력한 후 새로 만들기를 클릭합니다.
3. 등장한 **함수 작업 공간** 화면에서 saveUrl의 action 함수에  
`context.session.url = dialog.userInput.text;`
을 추가합니다. 즉, 다음과 같이 코드를 입력합니다. 
	```javscript
	bot.setTask('saveUrl', 
	{
		action: function (dialog, context, callback)
		{
			context.session.url = dialog.userInput.text;
			callback();
		}
	});
	```
4. 저장하기 버튼을 누르세요.

이제 사용자가 입력한 값(`dialog.userInput.text`)은 함수 작업 영역의 `context.session.url`에 저장되어 있습니다. 특정 카드에서 해당 값을 이용하고 싶을 경우, `context.session.url`을 통해 이용할 수 있습니다. 

마찬가지로 다음 단계에 따라 선택자를 저장하는 실행함수(saveSelector)를 만듭니다.
1. 선택자 입력 카드를 더블 클릭하여 카드 수정창을 엽니다.
2. 답변 전 실행함수에 saveSelector을 입력한 후 새로 만들기를 클릭합니다.
3. 등장한 **함수 작업 공간** 화면에서 saveSelector의 action 함수에  
`context.session.selector = dialog.userInput.text;`
을 추가합니다. 즉, 다음과 같이 코드를 입력합니다. 
	```javscript
	bot.setTask('saveSelector', 
	{
		action: function (dialog, context, callback)
		{
			context.session.selector = dialog.userInput.text;
			callback();
		}
	});
	```
4. 저장하기 버튼을 누르세요.

이제 사용자가 입력한 값(`dialog.userInput.text`)은 함수 작업 영역의 `context.session.selector`에 저장되어 있습니다. 특정 카드에서 해당 값을 이용하고 싶을 경우, `context.session.selector`을 통해 이용할 수 있습니다.

> 테스트하기
>1. 테스트 대화창에서 "크롤링" 이라고 입력합니다.
>2. 크롤링을 위해서 웹사이트 주소는 https://로 시작하며, 앞에 www.가 붙어 있는 주소를 입력합니다.
>3. 크롤링하기 원하는 웹 사이트의 특정 요소를 선택할 선택자를 입력합니다. 
>    * 선택자(Selector)란 웹 페이지에서 특정 요소를 선택하게 해주는 표현식이라고 이해할 수 있습니다(여기서는 선택자에 대한 사용법만 알아볼 것이며 다음의 설명은 크롬 브라우저 기준입니다). 
>    * 특정 웹 페이지에서 선택하고자하는 요소에 마우스를 가져간 다음 마우스 오른쪽 버튼을 클릭 후 검사 버튼을 선택합니다.
>    * 브라우저 화면 오른쪽에 개발자 도구 화면이 등장하고 자신이 검사한 요소가 개발자 도구 화면에 표시됩니다.
>    *  표시된 요소로 마우스를 가져간 다음 마우스 오른쪽 버튼을 클릭하고 Copy -> Copy Selector를 선택하면 해당 요소를 선택하는 선택자(Selector)가 복사됩니다.

### 저장된 변수 이용하기
`context.session.url`과 `context.session.selector`에 저장된 변수를 챗봇 답변에서 이용해보겠습니다.  
[![Watch the video](https://github.com/moneybrain-ai/PlayChat-Docs/blob/master/video/playyoutube1.png)](https://youtu.be/WX-4EMZ_61A)            

다음 단계에 따라 선택자 입력 카드를 수정합니다.
1. 선택자 입력 카드를 더블 클릭하여 카드 수정창을 엽니다.
2. 챗봇 답변에 다음과 같이 입력합니다.
url : +context.session.url+
selector : +context.session.selector+ 
크롤링하시겠습니까?
3. 저장하기 버튼을 누르세요.  
<a href="https://raw.githubusercontent.com/moneybrain-ai/PlayChat-Docs/master/start_image/22.png" target="_blank"><img src="https://github.com/moneybrain-ai/PlayChat-Docs/blob/master/start_image/22.png" title="클릭"/></a>  
+변수+와 같은 표현은 함수 작업 영역의 변수에 접근하기 위한 문법입니다. ++사이에 접근하고자 하는 변수를 입력합니다.

>테스트하기
>1. "크롤링" 입력합니다.
>2. 웹 사이트 주소를 입력합니다.
>3. 선택자를 입력합니다. 
>4. 챗봇이 url과 선택자를 정상적으로 출력합니다.  
<a href="https://raw.githubusercontent.com/moneybrain-ai/PlayChat-Docs/master/start_image/23.png" target="_blank"><img src="https://github.com/moneybrain-ai/PlayChat-Docs/blob/master/start_image/23.png" title="클릭"/></a>  

### 크롤링 실행하기
사용자로부터 입력받은 웹 사이트 주소(url)과 선택자를 이용하여 웹 크롤링을 실행하는 답변 전 실행함수를 만들어 보겠습니다.  
[![Watch the video](https://github.com/moneybrain-ai/PlayChat-Docs/blob/master/video/playyoutube1.png)](https://youtu.be/QLcXH2Vn7Wg)             

다음 단계에 따라 크롤링 실행 카드를 수정합니다.
1. 크롤링 실행 카드를 더블 클릭하여 카드 수정창을 엽니다.
2. 답변 전 실행함수에 executeCrawling을 입력한 후 새로 만들기를 클릭합니다.
3. 등장한 **함수 작업 공간** 화면에서 executeCrawling을 다음과 같이 입력합니다.
	```javscript
	bot.setTask('executeCrawling', 
	{
		action: function (dialog, context, callback)
				{
				    var request = require('request');
				    var cheerio = require('cheerio');
					
				    var url = context.session.url;
				    var selector = context.session.selector;
				    request(url, function (err, response, body) 
							  {
							      if(err)
							      {
								context.session.result = err.message;
						              }
							      else
						              {
								var $ = cheerio.load(body);
							        var result = $(selector).text();
							        context.session.result = result;
							      }
						              callback();
							  }
				    );
				}
	});
	```
4. 챗봇 답변에 다음과 같이 입력합니다.
크롤링 결과는 다음과 같습니다.
결과 : +context.session.result+
5. 저장하기 버튼을 누르세요.

>테스트하기
>1. 테스트 대화창에서 "크롤링" 이라고 입력합니다.
>2. 크롤링을 위해서 웹사이트 주소는 https://로 시작하며, 앞에 www.가 붙어 있는 주소를 입력합니다.
>3. 크롤링하기 원하는 웹 사이트의 특정 요소를 선택할 선택자를 입력합니다. 
>4. "실행"이라고 입력합니다.
>5.  해당 사이트의 선택자에 해당하는 요소를 읽어와 답변해줍니다.  
<a href="https://raw.githubusercontent.com/moneybrain-ai/PlayChat-Docs/master/start_image/24.png" target="_blank"><img src="https://github.com/moneybrain-ai/PlayChat-Docs/blob/master/start_image/24.png" title="클릭"/></a>  

### 마무리
지금까지 **답변 전 실행함수 적용하기**를 살펴봤습니다. 챗봇이 실제로 웹사이트를 클롤링하기 위해서 사용자의 입력값을 저장하는 함수와 크롤링을 실행하는 함수를 만들어 이용했습니다.
지금까지 살펴본 내용을 보다 자세하게 살펴보고 싶을 경우, 개요 문서를 참고해주세요.

