# 차례
*	[어떤 챗봇을 원하세요?](#어떤-챗봇을-원하세요)
	* [대화 시나리오](#대화-시나리오)
*	[`대화 시나리오`를 이용한 챗봇 구축하기](#대화-시나리오를-이용한-챗봇-구축하기)
	* [대화 카드 만들기](#대화-카드-만들기)
	* [크롤링 시나리오 만들기](#크롤링-시나리오-만들기)
	* [재질의 카드 만들기](#재질의-카드-만들기)
*	[`답변 전 실행함수` 적용하기](#답변-전-실행함수-적용하기)
	* [변수 저장하기](#변수-저장하기)
	* [저장된 변수 이용하기](#저장된-변수-이용하기)
	* [크롤링 실행하기](#크롤링-실행하기)

## 어떤 챗봇을 원하세요?
PlayChat 챗봇은 사용자의 질문과 챗봇 답변을 기본 단위로 하여 연속적인 대화를 이어나갑니다. PlayChat 챗봇은 크게 2가지 방식으로 만들 수 있습니다.  
<a href="https://raw.githubusercontent.com/moneybrain-ai/PlayChat-Docs/master/start_image/9.png" target="_blank"><img src="https://github.com/moneybrain-ai/PlayChat-Docs/blob/master/start_image/9.png" title="클릭"/></a>  

### 대화 시나리오
PlayChat이 제공하는 대화 시나리오 그래프를 이용해 챗봇을 구축하는 방법입니다. 대화 시나리오를 이용할 경우 일대일 질문 답변을 넘어, 특정 절차와 기능이 필요한 대화(크롤링, 핸드폰 인증하기, 외부 서버 연동하기 등)를 구현할 수 있습니다.  
[![Video Label](http://img.youtube.com/vi/DhFCZkb-zVM/0.jpg)](https://youtu.be/DhFCZkb-zVM?t=0s)

>참고
>* 대화 셋과 대화 시나리오를 연계하여 챗봇을 구축할 수 있으며, 이 경우 더욱 자연스럽고 실용적인 챗봇을 만들 수 있습니다. 
>* 만들고자하는 챗봇의 목적에 따라 대화 셋을 기반으로 챗봇을 구축할지, 아니면 대화 시나리오를 기반으로 챗봇을 구축할지 결정하는 것이 좋습니다.


## 대화 시나리오를 이용한 챗봇 구축하기
이 문서에서는 **대화 시나리오**를 이용하여 기초적인 **크롤링 챗봇** 을 만들어봅니다. 크롤링 챗봇은 특정 웹 페이지의 데이터를 추출해 내는 챗봇입니다.

대화 시나리오를 이용해 챗봇을 구축하기 위해서는 사용자 입력과 챗봇 답변으로 이루어진 대화 시나리오의 기본 단위(카드)를 만들어야 합니다. 대화 시나리오는 사용자 입력과 챗봇 답변으로 이루어진 대화 카드의 집합으로 이루어지며, 다중의 대화 시나리오를 챗봇에 학습시킬 수도 있습니다.

### 챗봇 만들기
다음 단계에 따라 챗봇을 생성합니다.

1. PlayChat 계정이 없다는 먼저 회원가입을 진행해주세요. 만약 PlayChat 계정이 있다면 로그인 해주세요.
2. "챗봇 관리" 화면에서 새 봇 만들기 -> 빈봇 을 선택합니다. 
3. 빈 칸을 입력합니다.
4. 저장 버튼을 누르세요.

챗봇이 생성되면 챗봇이 카드 형태로 나타납니다. 챗봇 개발을 위해 만들어진 챗봇을 선택합니다.


### 대화 카드 만들기   

대화 시나리오는 사용자 입력과 챗봇 출력으로 이루어진 카드로 구성됩니다. 고급 기능을 이용할 경우, 답변 전 실행함수를 카드에 추가할 수 있습니다. 

다음 단계에 따라 카드를 만듭니다.
<a href="https://youtu.be/44QP-8ooqto" target = "_new">예제 동영상 보기</a>

1. 화면 왼쪽 네비게이션 바의 개발 -> 대화 시나리오를 선택합니다.
2. 시작 카드의 오른쪽 추가하기 버튼을 선택하고 카드 이름을 "비트코인 시작 카드" 라고 입력합니다. 카드 이름은 해당 카드를 지칭하는 이름으로써 카드에 대한 식별자입니다.
3. 사용자 입력 칸에는 예상되는 챗봇 사용자의 질문을 입력합니다. 비트코인 봇을 만들고 있기 때문에, 사용자 입력에 비트코인에 대한 질문을 입력합니다. 다양한 질문들을 입력할수록 다양한 사용자의 입력을 챗봇이 이해할 수 있습니다.
다음의 예시 질문들을 사용자 입력에 입력하세요. 복수의 사용자 입력을 입력하기 위해서는 사용자 입력 칸의 + 버튼을 누르세요. 
	* 비트코인
	* 코인
	* 비트코인 시작
4. 챗봇 출력 칸에는  챗봇이 출력할 답변을 입력합니다. 어떤 비트코인을 검색할지 묻는 질문을 답변으로 입력합니다. 
다음의 예시 답변들을 챗봇 출력에 입력하세요. 복수의 챗봇 출력을 입력하기 위해서는 챗봇 출력 칸의 + 버튼을 누르세요. 
	* 어떤 비트코인을 검색할까요?
	* 검색하고자 하는 비트코인을 알려주세요.

	 챗봇 출력을 복수로 입력했을 경우, 랜덤으로 복수의 답변 중 하나가 출력됩니다.
5. 저장 버튼을 누르세요.
6. 테스트하기.
	화면 오른쪽 테스트 대화창에서 카드의 사용자 입력 칸에 저장한 질문을 입력해보세요. 준비된 챗봇 출력이 출력되는 걸 확인할 수 있습니다.

> <em>Tip</em>
> 화면 아래에 실시간 대화 분석창이 등장합니다. 사용자 입력과 챗봇 출력으로 구성된 대화의 기본 단위 카드에 대한 분석을 제공합니다. 
> * 사용자 입력 분석 - 챗봇 사용자의 입력값을 자연어 처리하여 그 결과를 보여줍니다.
> * 인텐트 분석 - 챗봇 사용자의 입력값과 매칭된 인텐트를 보여줍니다.
> * 엔터티 분석 - 챗봇 사용자의 입력값에서 축출된 엔터티를 보여줍니다.
> * 챗봇 출력 분석 - 챗봇 사용자의 입력값이 카드와 매칭되어 챗봇 출력이 출력되었는지에 관한 정보를 보여줍니다.



### 비트코인 검색 시나리오 만들기  

대화 시나리오는 카드들의 집합입니다. 시작 카드에 비트코인 시작 카드를 추가했던 것처럼, 특정 카드에 자식카드를 추가하거나 형제 카드를 추가할 수 있습니다. 다수의 카드들을 연결하게 되면 카드들은 트리 형태의 그래프가 되고, 이렇게 연결된 카드들을 대화 시나리오라고 칭합니다.  
<a href="https://youtu.be/lwenTu4GezA" target = "_new">예제 동영상 보기</a>

> <em>Tip</em>
> 대화 시나리오는 왜 필요할까요?
> 비트코인 챗봇이 사용자들로 부터 1) 검색하고자 하는 비트코인과 2) 해당 비트코인에서 얻고자하는 정보를 입력받고 3) 검색을 실행하는 경우를 살펴보겠습니다. 
>
>1. 검색하기 원하는 비트코인을 입력 받는다.
>2. 해당 비트코인에 대해 얻고자하는 정보를 입력 받는다.
>3. 검색한다.
>    * 검색 결과가 문제 없을 경우, 해당 결과를 출력한다.
>    * 검색 결과가 없을 경우, 비트코인 재입력(1번) 절차로 돌아가거나, 해당 비트코인에서 얻고자하는 정보 재입력(2번) 절차로 돌아간다.
>
>검색 기능을 수행하기 위해 위의 절차가 순서대로 진행됩니다. 이 때, 하나의 카드로 모든 절차를 구현할 수 있지만 초보자에게는 어렵거나 직관적이지 않을 수 있습니다. 왜냐하면 **하나의 카드는 원칙적으로 하나의 기능을 구현**하는 것이 쉽고, 직관적이기 때문입니다. 검색 시나리오의 경우 비트코인 이름을 입력받는 기능과 원하는 정보를 입력받는 기능 그리고 검색 기능을 이용하기에 3 개의 카드를 연결하여 비트코인 시나리오를 만드는 것이 편리하고 직관적입니다. 즉, 어떤 기능을 수행하기 위해 특정 절차를 만드는 것이 편리하거나 필요할 경우, 자식 카드를 추가하여 시나리오를 만들 수 있습니다. 



다음 단계에 따라 비트코인 검색  시나리오를 만듭니다.  

1. 비트코인 시작 카드의 자식카드로 "비트코인 이름 입력" 카드를 만듭니다.
	* 카드 이름 - 비트코인 이름 입력
	* 사용자 입력 - if(true)
	* 챗봇 출력 - 비트코인에서 얻고자하는 정보를 입력하세요.

	사용자 입력에 if()를 입력할 경우, 입력 모드가 변합니다. if(true)라고 입력합니다. if(조건식)의 경우 사용자의 입력값과 상관없이 해당 카드를 실행하겠다는 의미입니다. 조건식에는 자바스크립트 코드가 들어갑니다. 조건식으로 true 값을 넣을 경우, 조건식은 항상 실행됨을 의미하게 됩니다.

2. 비트코인 이름 입력 카드의 자식카드로 "검색 정보 입력" 카드를 만듭니다.
	* 카드 이름 - 검색 정보 입력
	* 사용자 입력 - if(true)
	* 챗봇 출력 - 검색하시겠습니까?

3. 검색 정보 입력 카드의 자식 카드로 "검색 실행" 카드를 만듭니다. 
	* 카드 이름 - 검색 실행
	* 사용자 입력 - 실행
	* 챗봇 출력 - 비트코인 검색 결과는 다음과 같습니다. 
<img src="https://github.com/moneybrain-ai/PlayChat-Docs/blob/master/start_image/17.png" title="클릭"/>
4. 테스트하기.
	*	비트코인 시작 - 비트코인 시작 이라고 입력했을 경우, 웹사이트 주소를 입력하라고 챗봇이 답변합니다. 
	*	웹사이트 주소 입력 - 웹사이트 주소를 정확히 입력했을 경우, 해당 웹사이트의 선택자를 입력하라고 챗봇이 답변합니다. 
	*	선택자 입력 - 선택자를 입력했을 경우, 비트코인 진행 여부를 물어봅니다. 
	*	비트코인 실행 - 실행이라고 입력했을 경우, 비트코인 결과를 챗봇이 답변합니다.  
<img src="https://github.com/moneybrain-ai/PlayChat-Docs/blob/master/start_image/18.png" title="클릭"/>

비트코인 검색 기능을 수행하기 위한 기본적인 대화 시나리오가 완성되었습니다. 지금부터는 사용자가 웹사이트 주소를 제대로 입력하지 않았을 경우, 이를 다시 입력받는 방법을 살펴보겠습니다.

### 마무리
지금까지 **대화 시나리오를 이용한 챗봇 구축하기**를 살펴봤습니다. 대화 시나리오를 이용한 챗봇은 대화 카드를 연결하여, 시나리오를 이용한 챗봇을 구축할 수 있었습니다. 하지만, 실제로 챗봇이 비트코인을 검색하기 위해서는 답변 전 실행함수를 추가해야 합니다. 
다음 문서(답변 전 실행함수 적용하기)에서는 실제로 비트코인를 검색하는 기능을 실현해봅니다. 


## 답변 전 실행함수 적용하기
답변 전 실행함수는 외부의 자원(비트코인 가격, 날씨 정보, 영화 정보 등)을 이용해야 하는 경우나, 코드 레벨에서의 조작이 필요한 경우에 이용할 수 있는 기능입니다. 예를 들어, 비트코인 봇이 검색을 실행하기 위해서는 검색할 비트코인의 이름과 해당 비트코인에서 얻고자하는 정보를 저장해야하고, 검색을 실행하는 기능이 필요합니다. 이 문서에서는 해당 기능들을 구현해봅니다.
<a href="https://youtu.be/os-xEqSxn9w" target="_new">예제 동영상 보기</a>

### 변수 저장하기
검색을 위해서는 사용자가 입력한 비트코인 이름과 얻고자하는 정보를 저장해두어야 합니다. 사용자의 입력 값을 저장하기 위해 답변 적 실행함수를 이용합니다.

다음 단계에 따라 답변 전 실행함수(saveBitcoinName)를 만듭니다.  
<img src="https://github.com/moneybrain-ai/PlayChat-Docs/blob/master/start_image/21.png" title="클릭"/>
1. 비트코인 이름 입력 카드를 더블 클릭하여 카드 수정창을 엽니다.
2. 답변 전 실행함수에 saveBitcoinName을 입력한 후 새로 만들기를 클릭합니다.
3. 등장한 **함수 작업 공간** 화면에서 saveBitcoinName의 action 함수에  
`context.session.bitcoinName = dialog.userInput.text;`
을 추가합니다. 즉, 다음과 같이 코드를 입력합니다. 
	```javscript
	bot.setTask('saveBitcoinName', 
	{
		action: function (dialog, context, callback)
		{
			context.session.bitcoinName = dialog.userInput.text;
			callback();
		}
	});
	```
4. 저장하기 버튼을 누르세요.

이제 사용자가 입력한 값(`dialog.userInput.text`)은 함수 작업 영역의 `context.session.bitcoinName`에 저장되어 있습니다. 특정 카드에서 해당 값을 이용하고 싶을 경우, `context.session.bitcoinName`을 통해 이용할 수 있습니다. 

마찬가지로 다음 단계에 따라 검색 정보를 저장하는 실행함수(saveInfo)를 만듭니다.
1. 검색 정보 입력 카드를 더블 클릭하여 카드 수정창을 엽니다.
2. 답변 전 실행함수에 saveInfo을 입력한 후 새로 만들기를 클릭합니다.
3. 등장한 **함수 작업 공간** 화면에서 saveInfo의 action 함수에  
`context.session.info = dialog.userInput.text;`
을 추가합니다. 즉, 다음과 같이 코드를 입력합니다. 
	```javscript
	bot.setTask('saveInfo', 
	{
		action: function (dialog, context, callback)
		{
			context.session.info = dialog.userInput.text;
			callback();
		}
	});
	```
4. 저장하기 버튼을 누르세요.

이제 사용자가 입력한 값(`dialog.userInput.text`)은 함수 작업 영역의 `context.session.info`에 저장되어 있습니다. 특정 카드에서 해당 값을 이용하고 싶을 경우, `context.session.info`을 통해 이용할 수 있습니다.

5. 테스트하기
	* 테스트 대화창에서 "비트코인" 이라고 입력합니다.
	* 비트코인 이름을 입력합니다.
	* 검색할 비트코인의 정보를 입력합니다.

### 저장된 변수 이용하기
`context.session.bitcoinName`과 `context.session.info`에 저장된 변수를 챗봇 답변에서 이용해보겠습니다.
<a href="https://youtu.be/WX-4EMZ_61A" target="_new">예제 동영상 보기</a>       

다음 단계에 따라 검색 정보 입력 카드를 수정합니다.
1. 검색 정보 입력 카드를 더블 클릭하여 카드 수정창을 엽니다.
2. 챗봇 답변에 다음과 같이 입력합니다.
비트코인 이름 : +context.session.bitcoinName+
검색 정보 : +context.session.info+ 
검색하시겠습니까?

3. 저장하기 버튼을 누르세요.  
<img src="https://github.com/moneybrain-ai/PlayChat-Docs/blob/master/start_image/22.png" title="클릭"/>
+변수+와 같은 표현은 함수 작업 영역의 변수에 접근하기 위한 문법입니다. ++사이에 접근하고자 하는 변수를 입력합니다.

4. 테스트하기
	*	"비트코인" 입력합니다.
	*	비트코인 이름을 입력합니다.
	*	검색 정보를 입력합니다.
	*	챗봇이 비트코인 이름과 검색 정보를 정상적으로 출력합니다.
<img src="https://github.com/moneybrain-ai/PlayChat-Docs/blob/master/start_image/23.png" title="클릭"/>

### 검색 실행하기
사용자로부터 입력받은 비트코인 이름과 검색 정보를 이용하여 검색을 실행하는 답변 전 실행함수를 만들어 보겠습니다.  
<a href="https://youtu.be/QLcXH2Vn7Wg" target="_new">예제 동영상</a>

다음 단계에 따라 크롤링 실행 카드를 수정합니다.
1. 검색 실행 카드를 더블 클릭하여 카드 수정창을 엽니다.
2. 답변 전 실행함수에 searchBitcoin을 입력한 후 새로 만들기를 클릭합니다.
3. 등장한 **함수 작업 공간** 화면에서 searchBitcoin을 다음과 같이 입력합니다.
	```javscript
	bot.setTask('searchBitcoin', 
	{
		action: function (dialog, context, callback)
				{
				    var request = require('request');
				    var cheerio = require('cheerio');
					
				    var url = "https://bittrex.com/api/v1.1/public/getmarketsummary?market=btc-";
				    url += context.session.bitcoinName
				    request(url, function (err, response, body) 
							  {
							      if(err)
							      {
									context.session.result = err.message;
						          }
							      else
						          {
									if(!body.success)
									{
										context.session.result = body.message;
									}
									else
									{
										context.session.result = body.result[0][context.session.info]
									}
							      }
						          callback();
							  }
				    );
				}
	});
	```
4. 챗봇 답변에 다음과 같이 입력합니다.
검색 결과는 다음과 같습니다.
결과 : +context.session.result+
5. 저장하기 버튼을 누르세요.
6. 테스크하기
	*	테스트 대화창에서 "비트코인" 이라고 입력합니다.
	*	비트코인 이름을 입력합니다.
	*	검색 정보를 입력합니다.
	*	"실행"이라고 입력합니다.

<img src="https://github.com/moneybrain-ai/PlayChat-Docs/blob/master/start_image/24.png" title="클릭"/>

### 마무리
지금까지 **답변 전 실행함수 적용하기**를 살펴봤습니다. 사용자의 입력값을 저장하는 함수와 외부 AIP를 이용하는 함수를 만들었습니다.
지금까지 살펴본 내용을 보다 자세하게 살펴보고 싶을 경우, 개요 문서를 참고해주세요.
